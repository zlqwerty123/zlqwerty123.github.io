<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿„ç½—æ–¯æ–¹å— | cnfespop.github.io</title>
    <style>
        /* æ•´ä½“é£æ ¼å»¶ç»­è´ªåƒè›‡çš„æŸ”å’Œè®¾è®¡ */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f9fa;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            padding-bottom: 100px;
        }

        /* æ ‡é¢˜ - æ¸å˜æŸ”å’Œé£æ ¼ */
        h1 {
            color: #2c3e50;
            margin: 20px 0;
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, #9b59b6, #3498db);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* æ¸¸æˆä¿¡æ¯é¢æ¿ï¼ˆåˆ†æ•°ã€æç¤ºï¼‰ */
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 360px;
            margin-bottom: 15px;
        }

        .score, .hint {
            font-size: 1.2rem;
            font-weight: 500;
            color: #34495e;
            padding: 8px 20px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* æ¸¸æˆç”»å¸ƒ - åœ†è§’+æŸ”å’Œé˜´å½± */
        #gameCanvas {
            border: none;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* æ¸¸æˆç»“æŸæç¤º */
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: 600;
            color: #e74c3c;
            display: none;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            text-align: center;
            line-height: 1.6;
        }

        /* è§¦æ§æŒ‰é’®å®¹å™¨ */
        .control-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }

        /* æ–¹å‘/åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .dir-btn, .func-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        .dir-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .func-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .dir-btn:active, .func-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* æŒ‰é’®å¸ƒå±€ */
        .top-func-btns {
            display: flex;
            gap: 10px;
        }

        .middle-dir-btns {
            display: flex;
            gap: 10px;
        }

        .restart-btn {
            margin-top: 20px;
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            color: white;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .restart-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <h1>ä¿„ç½—æ–¯æ–¹å—å°æ¸¸æˆ</h1>
    <div class="game-info">
        <div class="score">åˆ†æ•°: <span id="scoreNum">0</span></div>
        <div class="hint">â†‘æ—‹è½¬ | â†“åŠ é€Ÿ</div>
    </div>
    <canvas id="gameCanvas" width="360" height="400"></canvas>
    <div class="game-over" id="gameOver">æ¸¸æˆç»“æŸå•¦ ğŸ˜¢<br>åˆ†æ•°: <span id="finalScore">0</span><br>ç‚¹å‡»æŒ‰é’®é‡æ–°å¼€å§‹</div>

    <!-- è§¦æ§æŒ‰é’® -->
    <div class="control-buttons">
        <div class="top-func-btns">
            <button class="func-btn" id="rotateBtn">â†º</button>
            <button class="func-btn" id="downFastBtn">â†“â†“</button>
        </div>
        <div class="middle-dir-btns">
            <button class="dir-btn" id="leftBtn">â†</button>
            <button class="dir-btn" id="downBtn">â†“</button>
            <button class="dir-btn" id="rightBtn">â†’</button>
        </div>
        <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹æ¸¸æˆ</button>
    </div>

    <script>
        // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreNum = document.getElementById('scoreNum');
        const gameOver = document.getElementById('gameOver');
        const finalScore = document.getElementById('finalScore');

        // è§¦æ§æŒ‰é’®
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const downBtn = document.getElementById('downBtn');
        const rotateBtn = document.getElementById('rotateBtn');
        const downFastBtn = document.getElementById('downFastBtn');
        const restartBtn = document.getElementById('restartBtn');

        // æ¸¸æˆé…ç½®
        const blockSize = 20; // æ¯ä¸ªæ–¹å—çš„å¤§å°
        const cols = 18; // åˆ—æ•° (360/20)
        const rows = 20; // è¡Œæ•° (400/20)

        // æ¸¸æˆåŒºåŸŸï¼ˆäºŒç»´æ•°ç»„ï¼Œ0=ç©ºï¼Œ1-7=ä¸åŒé¢œè‰²çš„æ–¹å—ï¼‰
        let gameBoard = Array(rows).fill().map(() => Array(cols).fill(0));

        // ä¿„ç½—æ–¯æ–¹å—å½¢çŠ¶å’Œé¢œè‰²ï¼ˆ7ç§ç»å…¸å½¢çŠ¶ï¼‰
        const tetrominoes = [
            // I
            { shape: [[1,1,1,1]], color: '#3498db' },
            // J
            { shape: [[1,0,0],[1,1,1]], color: '#2980b9' },
            // L
            { shape: [[0,0,1],[1,1,1]], color: '#9b59b6' },
            // O
            { shape: [[1,1],[1,1]], color: '#f1c40f' },
            // S
            { shape: [[0,1,1],[1,1,0]], color: '#2ecc71' },
            // T
            { shape: [[0,1,0],[1,1,1]], color: '#e67e22' },
            // Z
            { shape: [[1,1,0],[0,1,1]], color: '#e74c3c' }
        ];

        // å½“å‰æ–¹å—çŠ¶æ€
        let currentTetromino = null;
        let currentX = 0;
        let currentY = 0;
        let score = 0;
        let gameRunning = true;

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameBoard = Array(rows).fill().map(() => Array(cols).fill(0));
            score = 0;
            scoreNum.textContent = score;
            gameRunning = true;
            gameOver.style.display = 'none';
            spawnTetromino(); // ç”Ÿæˆæ–°æ–¹å—
            gameLoop(); // å¯åŠ¨æ¸¸æˆå¾ªç¯
        }

        // ç”Ÿæˆéšæœºæ–¹å—
        function spawnTetromino() {
            const randomIndex = Math.floor(Math.random() * tetrominoes.length);
            currentTetromino = tetrominoes[randomIndex];
            // åˆå§‹ä½ç½®ï¼ˆå±…ä¸­ï¼‰
            currentX = Math.floor(cols / 2) - Math.floor(currentTetromino.shape[0].length / 2);
            currentY = 0;

            // æ£€æµ‹æ¸¸æˆç»“æŸï¼ˆæ–°æ–¹å—ç”Ÿæˆå°±ç¢°æ’ï¼‰
            if (checkCollision(currentTetromino.shape, currentX, currentY)) {
                endGame();
            }
        }

        // ç¢°æ’æ£€æµ‹
        function checkCollision(shape, x, y) {
            for (let row = 0; row < shape.length; row++) {
                for (let col = 0; col < shape[row].length; col++) {
                    if (shape[row][col]) {
                        const newX = x + col;
                        const newY = y + row;
                        // è¶…å‡ºè¾¹ç•Œæˆ–å·²æœ‰æ–¹å—
                        if (newX < 0 || newX >= cols || newY >= rows || (newY >= 0 && gameBoard[newY][newX])) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        // å›ºå®šæ–¹å—åˆ°æ¸¸æˆåŒºåŸŸ
        function lockTetromino() {
            for (let row = 0; row < currentTetromino.shape.length; row++) {
                for (let col = 0; col < currentTetromino.shape[row].length; col++) {
                    if (currentTetromino.shape[row][col]) {
                        const y = currentY + row;
                        const x = currentX + col;
                        if (y >= 0) {
                            // ç”¨é¢œè‰²å¯¹åº”çš„æ•°å­—æ ‡è®°ï¼ˆé¿å…å’Œ0é‡å¤ï¼‰
                            gameBoard[y][x] = tetrominoes.findIndex(t => t.color === currentTetromino.color) + 1;
                        }
                    }
                }
            }
            // æ£€æŸ¥æ¶ˆè¡Œ
            clearLines();
            // ç”Ÿæˆæ–°æ–¹å—
            spawnTetromino();
        }

        // æ¶ˆè¡Œé€»è¾‘
        function clearLines() {
            let linesCleared = 0;
            for (let row = rows - 1; row >= 0; row--) {
                // æ£€æŸ¥æ•´è¡Œæ˜¯å¦å¡«æ»¡
                if (gameBoard[row].every(cell => cell !== 0)) {
                    linesCleared++;
                    // åˆ é™¤å½“å‰è¡Œï¼Œåœ¨é¡¶éƒ¨æ·»åŠ ç©ºè¡Œ
                    gameBoard.splice(row, 1);
                    gameBoard.unshift(Array(cols).fill(0));
                    // è¡Œç´¢å¼•ä¸å˜ï¼ˆå› ä¸ºåˆ é™¤åä¸‹ä¸€è¡Œå˜æˆå½“å‰è¡Œï¼‰
                    row++;
                }
            }
            // åŠ åˆ†ï¼ˆæ¶ˆè¡Œæ•°è¶Šå¤šåˆ†è¶Šé«˜ï¼‰
            if (linesCleared > 0) {
                score += linesCleared * 100;
                scoreNum.textContent = score;
            }
        }

        // æ—‹è½¬æ–¹å—
        function rotateTetromino() {
            // æ—‹è½¬çŸ©é˜µï¼ˆè½¬ç½®+åè½¬æ¯è¡Œï¼‰
            const rotatedShape = currentTetromino.shape[0].map((_, index) => 
                currentTetromino.shape.map(row => row[index]).reverse()
            );
            // æ£€æµ‹æ—‹è½¬åæ˜¯å¦ç¢°æ’ï¼Œä¸ç¢°æ’åˆ™æ›¿æ¢
            if (!checkCollision(rotatedShape, currentX, currentY)) {
                currentTetromino.shape = rotatedShape;
            }
        }

        // ç§»åŠ¨æ–¹å—
        function moveTetromino(dx, dy) {
            if (!checkCollision(currentTetromino.shape, currentX + dx, currentY + dy)) {
                currentX += dx;
                currentY += dy;
                return true;
            }
            // å‘ä¸‹ç§»åŠ¨ç¢°æ’åˆ™å›ºå®šæ–¹å—
            if (dy > 0) {
                lockTetromino();
                return false;
            }
            return false;
        }

        // å¿«é€Ÿä¸‹è½
        function dropTetromino() {
            while (moveTetromino(0, 1)) {}
        }

        // ç»˜åˆ¶æ¸¸æˆç”»é¢
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶æ¸¸æˆåŒºåŸŸçš„å›ºå®šæ–¹å—
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameBoard[row][col] !== 0) {
                        // æ ¹æ®æ•°å­—æ‰¾åˆ°å¯¹åº”é¢œè‰²
                        const color = tetrominoes[gameBoard[row][col] - 1].color;
                        drawBlock(col * blockSize, row * blockSize, color);
                    }
                }
            }

            // ç»˜åˆ¶å½“å‰ç§»åŠ¨çš„æ–¹å—
            if (currentTetromino) {
                for (let row = 0; row < currentTetromino.shape.length; row++) {
                    for (let col = 0; col < currentTetromino.shape[row].length; col++) {
                        if (currentTetromino.shape[row][col]) {
                            const x = (currentX + col) * blockSize;
                            const y = (currentY + row) * blockSize;
                            drawBlock(x, y, currentTetromino.color);
                        }
                    }
                }
            }
        }

        // ç»˜åˆ¶å•ä¸ªæ–¹å—ï¼ˆåœ†è§’+è¾¹æ¡†ï¼‰
        function drawBlock(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(x + 1, y + 1, blockSize - 2, blockSize - 2, 3);
            ctx.fill();
            // åŠ æµ…è¾¹æ¡†å¢å¼ºç«‹ä½“æ„Ÿ
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        // æ¸¸æˆç»“æŸ
        function endGame() {
            gameRunning = false;
            finalScore.textContent = score;
            gameOver.style.display = 'block';
        }

        // æ¸¸æˆä¸»å¾ªç¯
        let dropInterval = 1000; // æ¯ç§’ä¸‹è½ä¸€æ ¼
        let lastDropTime = 0;
        function gameLoop(timestamp = 0) {
            if (!gameRunning) return;

            // æ§åˆ¶ä¸‹è½é€Ÿåº¦
            if (timestamp - lastDropTime > dropInterval) {
                moveTetromino(0, 1);
                lastDropTime = timestamp;
            }

            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            switch(e.key) {
                case 'ArrowLeft': moveTetromino(-1, 0); break;
                case 'ArrowRight': moveTetromino(1, 0); break;
                case 'ArrowDown': moveTetromino(0, 1); break;
                case 'ArrowUp': rotateTetromino(); break;
                case ' ': dropTetromino(); break; // ç©ºæ ¼é”®å¿«é€Ÿä¸‹è½
            }
        });

        // è§¦æ§æŒ‰é’®æ§åˆ¶
        leftBtn.addEventListener('click', () => gameRunning && moveTetromino(-1, 0));
        rightBtn.addEventListener('click', () => gameRunning && moveTetromino(1, 0));
        downBtn.addEventListener('click', () => gameRunning && moveTetromino(0, 1));
        rotateBtn.addEventListener('click', () => gameRunning && rotateTetromino());
        downFastBtn.addEventListener('click', () => gameRunning && dropTetromino());
        restartBtn.addEventListener('click', initGame);

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
    </script>
</body>
</html>
