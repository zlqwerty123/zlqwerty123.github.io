<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»å…¸æ‰«é›· | cnfespop.github.io</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f9fa;
            font-family: "Microsoft YaHei", sans-serif;
            /* ç¦æ­¢å…¨å±€æ–‡æœ¬é€‰æ‹© */
            user-select: none;
            -webkit-user-select: none;
        }

        h1 {
            color: #27ae60;
            margin-bottom: 20px;
        }

        /* è‡ªå®šä¹‰è®¾ç½®é¢æ¿ */
        .settings {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .settings input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
        }

        .settings button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
        }

        .game-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        #gameContainer {
            display: grid;
            gap: 2px;
            background: #bbb;
            padding: 2px;
            border-radius: 5px;
        }

        .cell {
            width: 30px;
            height: 30px;
            background: #ccc;
            border: none;
            border-radius: 2px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ç¦æ­¢æ ¼å­æ–‡æœ¬é€‰æ‹© */
            user-select: none;
            -webkit-user-select: none;
            /* å»æ‰ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        .cell.opened {
            background: #eee;
        }

        .cell.flagged {
            background: #f8c471;
            color: red;
        }

        .num-1 { color: blue; }
        .num-2 { color: green; }
        .num-3 { color: red; }
        .num-4 { color: darkblue; }
        .num-5 { color: brown; }
        .num-6 { color: teal; }
        .num-7 { color: black; }
        .num-8 { color: gray; }

        .restart-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #e74c3c;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ç»å…¸æ‰«é›·</h1>

    <!-- è‡ªå®šä¹‰è®¾ç½®ï¼šè¡Œ=æ¨ªå‘æ•°é‡ï¼Œåˆ—=ç«–å‘æ•°é‡ -->
    <div class="settings">
        <div>
            <label>è¡Œæ•°ï¼š</label>
            <input type="number" id="rowInput" min="5" max="20" value="10">
        </div>
        <div>
            <label>åˆ—æ•°ï¼š</label>
            <input type="number" id="colInput" min="5" max="20" value="10">
        </div>
        <div>
            <label>åœ°é›·æ•°ï¼š</label>
            <input type="number" id="mineInput" min="1" max="100" value="10">
        </div>
        <button id="applyBtn">åº”ç”¨</button>
    </div>

    <div class="game-info">
        <div>å‰©ä½™åœ°é›·ï¼š<span id="mineLeft">10</span></div>
        <div id="status">æ¸¸æˆä¸­</div>
    </div>

    <div id="gameContainer"></div>
    <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>

    <script>
        // æ ¸å¿ƒé…ç½®ï¼ˆè¡Œ=æ¨ªå‘æ ¼å­æ•°ï¼Œåˆ—=ç«–å‘æ ¼å­æ•°ï¼‰
        let rows = 10;    // æ¨ªå‘æ ¼å­æ•°
        let cols = 10;    // ç«–å‘æ ¼å­æ•°
        let mineNum = 10; // åœ°é›·æ•°é‡
        const cellSize = 30;

        // æ¸¸æˆçŠ¶æ€
        let grid = [];     // æ£‹ç›˜æ•°æ®ï¼šgrid[ç«–å‘ç´¢å¼•][æ¨ªå‘ç´¢å¼•]
        let mines = [];    // åœ°é›·ä½ç½®ï¼š[{x:æ¨ªå‘ç´¢å¼•, y:ç«–å‘ç´¢å¼•}]
        let opened = 0;    // å·²æ‰“å¼€æ ¼å­æ•°
        let flagged = 0;   // å·²æ ‡è®°æ——å¸œæ•°
        let isFirstClick = true;
        let isGameOver = false;
        // ç§»åŠ¨ç«¯é•¿æŒ‰ç›¸å…³
        let longPressTimer = null;
        const LONG_PRESS_TIME = 300; // é•¿æŒ‰è§¦å‘æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // DOMå…ƒç´ 
        const gameContainer = document.getElementById('gameContainer');
        const mineLeftEl = document.getElementById('mineLeft');
        const statusEl = document.getElementById('status');
        const rowInput = document.getElementById('rowInput');
        const colInput = document.getElementById('colInput');
        const mineInput = document.getElementById('mineInput');
        const applyBtn = document.getElementById('applyBtn');
        const restartBtn = document.getElementById('restartBtn');

        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            // é‡ç½®çŠ¶æ€
            grid = [];
            mines = [];
            opened = 0;
            flagged = 0;
            isFirstClick = true;
            isGameOver = false;
            statusEl.textContent = 'æ¸¸æˆä¸­';
            statusEl.style.color = 'black';
            mineLeftEl.textContent = mineNum - flagged;

            // æ„å»ºç©ºæ£‹ç›˜
            for (let y = 0; y < cols; y++) { // y=ç«–å‘ç´¢å¼•
                grid[y] = [];
                for (let x = 0; x < rows; x++) { // x=æ¨ªå‘ç´¢å¼•
                    grid[y][x] = { isMine: false, isOpened: false, isFlagged: false };
                }
            }

            // è®¾ç½®æ£‹ç›˜æ ·å¼
            gameContainer.style.gridTemplateColumns = `repeat(${rows}, ${cellSize}px)`;
            renderBoard();
        }

        // æ¸²æŸ“æ£‹ç›˜
        function renderBoard() {
            gameContainer.innerHTML = '';
            for (let y = 0; y < cols; y++) {
                for (let x = 0; x < rows; x++) {
                    const cell = document.createElement('button');
                    cell.className = 'cell';
                    cell.dataset.x = x; // æ¨ªå‘ç´¢å¼•
                    cell.dataset.y = y; // ç«–å‘ç´¢å¼•

                    // æ˜¾ç¤ºçŠ¶æ€
                    const g = grid[y][x];
                    if (g.isOpened) {
                        cell.classList.add('opened');
                        if (g.isMine) {
                            cell.textContent = 'ğŸ’£';
                        } else {
                            const num = countNearMines(x, y);
                            if (num > 0) {
                                cell.textContent = num;
                                cell.classList.add(`num-${num}`);
                            }
                        }
                    } else if (g.isFlagged) {
                        cell.classList.add('flagged');
                        cell.textContent = 'ğŸš©';
                    }

                    // PCç«¯å³é”®æ ‡é›·
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault(); // é˜»æ­¢å³é”®èœå•
                        if (!isGameOver) toggleFlag(x, y);
                    });

                    // PCç«¯å·¦é”®å¼€æ ¼å­
                    cell.addEventListener('click', () => {
                        if (!isGameOver) clickCell(x, y);
                    });

                    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ï¼ˆä¿®å¤é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ï¼‰
                    cell.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º
                        const touchX = x;
                        const touchY = y;
                        // å¯åŠ¨é•¿æŒ‰è®¡æ—¶å™¨
                        longPressTimer = setTimeout(() => {
                            if (!isGameOver) toggleFlag(touchX, touchY);
                        }, LONG_PRESS_TIME);
                    });

                    cell.addEventListener('touchend', () => {
                        // çŸ­æŒ‰ï¼ˆæœªåˆ°é•¿æŒ‰æ—¶é—´ï¼‰â†’ å¼€æ ¼å­
                        clearTimeout(longPressTimer);
                        if (!isGameOver) clickCell(x, y);
                    });

                    cell.addEventListener('touchcancel', () => {
                        clearTimeout(longPressTimer);
                    });

                    gameContainer.appendChild(cell);
                }
            }
        }

        // ç”Ÿæˆåœ°é›·
        function generateMines(avoidX, avoidY) {
            let count = 0;
            while (count < mineNum) {
                const x = Math.floor(Math.random() * rows);
                const y = Math.floor(Math.random() * cols);
                // é¿å¼€é¦–æ¬¡ç‚¹å‡»ä½ç½® + ä¸é‡å¤ç”Ÿæˆ
                if ((x !== avoidX || y !== avoidY) && !grid[y][x].isMine) {
                    grid[y][x].isMine = true;
                    mines.push({x, y});
                    count++;
                }
            }
        }

        // è®¡ç®—ç›¸é‚»åœ°é›·æ•°
        function countNearMines(x, y) {
            let count = 0;
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < rows && ny >= 0 && ny < cols) {
                        if (grid[ny][nx].isMine) count++;
                    }
                }
            }
            return count;
        }

        // ç‚¹å‡»å¼€æ ¼å­
        function clickCell(x, y) {
            if (isGameOver || grid[y][x].isOpened || grid[y][x].isFlagged) return;

            // é¦–æ¬¡ç‚¹å‡»ç”Ÿæˆåœ°é›·ï¼ˆé¿å¼€å½“å‰ä½ç½®ï¼‰
            if (isFirstClick) {
                generateMines(x, y);
                isFirstClick = false;
            }

            // ç‚¹åˆ°åœ°é›·â†’æ¸¸æˆç»“æŸ
            if (grid[y][x].isMine) {
                gameOver();
                return;
            }

            // æ‰“å¼€æ ¼å­
            grid[y][x].isOpened = true;
            opened++;

            // ç©ºç™½æ ¼å­è‡ªåŠ¨å±•å¼€
            if (countNearMines(x, y) === 0) {
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < rows && ny >= 0 && ny < cols && !grid[ny][nx].isOpened) {
                            clickCell(nx, ny);
                        }
                    }
                }
            }

            // æ£€æŸ¥èƒœåˆ©
            if (opened === rows * cols - mineNum) {
                winGame();
            }

            renderBoard();
        }

        // æ ‡è®°/å–æ¶ˆæ ‡è®°åœ°é›·
        function toggleFlag(x, y) {
            if (isGameOver || grid[y][x].isOpened) return;

            // åˆ‡æ¢æ ‡è®°çŠ¶æ€
            grid[y][x].isFlagged = !grid[y][x].isFlagged;
            // é‡æ–°è®¡ç®—å·²æ ‡è®°æ•°é‡
            flagged = grid.flat().filter(c => c.isFlagged).length;
            // æ›´æ–°å‰©ä½™åœ°é›·æ˜¾ç¤º
            mineLeftEl.textContent = mineNum - flagged;

            renderBoard();
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            isGameOver = true;
            statusEl.textContent = 'æ¸¸æˆå¤±è´¥';
            statusEl.style.color = 'red';
            // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
            mines.forEach(m => {
                grid[m.y][m.x].isOpened = true;
            });
            renderBoard();
        }

        // æ¸¸æˆèƒœåˆ©
        function winGame() {
            isGameOver = true;
            statusEl.textContent = 'æ¸¸æˆèƒœåˆ© ğŸ‰';
            statusEl.style.color = 'green';
        }

        // åº”ç”¨è‡ªå®šä¹‰è®¾ç½®
        function applySettings() {
            const r = parseInt(rowInput.value) || 10;
            const c = parseInt(colInput.value) || 10;
            const m = parseInt(mineInput.value) || 10;

            // è¾¹ç•Œé™åˆ¶
            rows = Math.max(5, Math.min(20, r));
            cols = Math.max(5, Math.min(20, c));
            const maxMine = rows * cols - 1;
            mineNum = Math.max(1, Math.min(maxMine, m));

            // åŒæ­¥è¾“å…¥æ¡†å€¼
            rowInput.value = rows;
            colInput.value = cols;
            mineInput.value = mineNum;

            init();
        }

        // ç»‘å®šäº‹ä»¶
        applyBtn.addEventListener('click', applySettings);
        restartBtn.addEventListener('click', init);
        // å›è½¦åº”ç”¨è®¾ç½®
        [rowInput, colInput, mineInput].forEach(input => {
            input.addEventListener('keydown', e => e.key === 'Enter' && applySettings());
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        init();
    </script>
</body>
</html>
